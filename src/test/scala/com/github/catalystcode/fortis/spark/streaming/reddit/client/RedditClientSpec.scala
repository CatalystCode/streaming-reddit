package com.github.catalystcode.fortis.spark.streaming.reddit.client

import org.scalatest.FlatSpec

import scalaj.http.HttpRequest

class TestFetcher(val responses: Map[Option[String], String]) extends ResponseFetcher {
  override def fetchStringResponse(request: HttpRequest): String = {
    return responses(Option(request.url))
  }
}

class TestExceptionRedditClient(val exception: Exception) extends ResponseFetcher {
  override def fetchStringResponse(request: HttpRequest): String = {
    throw exception
  }
}

class TestRedditClient extends FlatSpec {

  "The reddit client" should "produce domain objects from the json api response" in {
    val responseString = "{\"kind\": \"Listing\", \"data\": {\"facets\": {}, \"modhash\": \"\", \"children\": [{\"kind\": \"t3\", \"data\": {\"contest_mode\": false, \"subreddit_name_prefixed\": \"r/arableaks\", \"banned_by\": null, \"media_embed\": {}, \"thumbnail_width\": null, \"subreddit\": \"arableaks\", \"selftext_html\": \"&lt;!-- SC_OFF --&gt;&lt;div class=\\\"md\\\"&gt;&lt;p&gt;Trumpcare on Life Support as Senate Punts Until After the Holiday Recess&lt;/p&gt;\\n\\n&lt;p&gt;by via Sputnik International&lt;/p&gt;\\n\\n&lt;p&gt;URL: &lt;a href=\\\"http://ift.tt/2s0NpQ6\\\"&gt;http://ift.tt/2s0NpQ6&lt;/a&gt;&lt;/p&gt;\\n\\n&lt;p&gt;On this episode of Fault Lines, Garland and Lee discuss the GOP healthcare bill&amp;#39;s possible demise as the Senate postpones the motion to proceed vote, the Trump Administration&amp;#39;s latest threats against Syria Russia and China, and a recent video showing a CNN producer admitting that their Russiagate coverage is ratings driven.&lt;/p&gt;\\n&lt;/div&gt;&lt;!-- SC_ON --&gt;\", \"selftext\": \"Trumpcare on Life Support as Senate Punts Until After the Holiday Recess\\n   \\n by via Sputnik International\\n   \\n URL: http://ift.tt/2s0NpQ6\\n   \\n On this episode of Fault Lines, Garland and Lee discuss the GOP healthcare bill's possible demise as the Senate postpones the motion to proceed vote, the Trump Administration's latest threats against Syria Russia and China, and a recent video showing a CNN producer admitting that their Russiagate coverage is ratings driven.\\n   \\n   \\n\", \"likes\": null, \"suggested_sort\": null, \"user_reports\": [], \"secure_media\": null, \"link_flair_text\": null, \"id\": \"6jzbmy\", \"view_count\": null, \"secure_media_embed\": {}, \"clicked\": false, \"report_reasons\": null, \"author\": \"feedreddit\", \"saved\": false, \"mod_reports\": [], \"name\": \"t3_6jzbmy\", \"score\": 1, \"approved_by\": null, \"over_18\": false, \"domain\": \"self.arableaks\", \"hidden\": false, \"preview\": {\"images\": [{\"source\": {\"url\": \"https://i.redditmedia.com/pOPChNLJ3b35UMz7K91DW95s0gtsC8yUJ7uAhCaBSO8.jpg?s=3b3da04dfc0d68a49c5f90dc12c27c03\", \"width\": 638, \"height\": 450}, \"resolutions\": [{\"url\": \"https://i.redditmedia.com/pOPChNLJ3b35UMz7K91DW95s0gtsC8yUJ7uAhCaBSO8.jpg?fit=crop&amp;crop=faces%2Centropy&amp;arh=2&amp;w=108&amp;s=82aa23c4274d0548258eb99f192db3c2\", \"width\": 108, \"height\": 76}, {\"url\": \"https://i.redditmedia.com/pOPChNLJ3b35UMz7K91DW95s0gtsC8yUJ7uAhCaBSO8.jpg?fit=crop&amp;crop=faces%2Centropy&amp;arh=2&amp;w=216&amp;s=1baeb298fabde06ccff129242201b4e7\", \"width\": 216, \"height\": 152}, {\"url\": \"https://i.redditmedia.com/pOPChNLJ3b35UMz7K91DW95s0gtsC8yUJ7uAhCaBSO8.jpg?fit=crop&amp;crop=faces%2Centropy&amp;arh=2&amp;w=320&amp;s=8f6efbbd8e6e9bcb318dc2715bf29656\", \"width\": 320, \"height\": 225}], \"variants\": {}, \"id\": \"CC_2oyPfjBKYQIiW8WEjhUeoW-jOBDYRiaYMbRq6Paw\"}], \"enabled\": false}, \"thumbnail\": \"self\", \"subreddit_id\": \"t5_33yiw\", \"edited\": false, \"link_flair_css_class\": null, \"author_flair_css_class\": null, \"gilded\": 0, \"downs\": 0, \"brand_safe\": false, \"archived\": false, \"removal_reason\": null, \"sr_detail\": {\"banner_img\": \"\", \"user_is_banned\": null, \"description\": \"\\u0639\\u0631\\u0628 of reddit, Unite!\\n\\n\\nWelcome to /r/Arableaks , a subreddit for  news/information concerning the Arab region and for those who wish to engage in constructive, civil discussion about world/Arab events . People from all organizations, groups, and tendencies are welcome.\\n\\n**Rules:**\\n\\nJust DO NOT Post comments which include, promote for racism, sexism, transphobia, rape, genocide/ethnic cleansing, fascism, homophobia or queer bashing , otherwise feel free to contribute .\", \"user_is_muted\": null, \"display_name\": \"arableaks\", \"header_img\": \"https://b.thumbs.redditmedia.com/nLji0owHL8FoKv1Fo9iAX_B7Xxh-yBetkbbopj1xjMk.png\", \"title\": \"Arab leaks\", \"user_is_moderator\": null, \"over_18\": false, \"icon_size\": null, \"icon_img\": \"\", \"display_name_prefixed\": \"r/arableaks\", \"header_size\": [169, 160], \"subscribers\": 60, \"key_color\": \"\", \"name\": \"t5_33yiw\", \"url\": \"/r/arableaks/\", \"banner_size\": null, \"user_is_contributor\": null, \"public_description\": \"\\u0639\\u0631\\u0628 of reddit!\\n\\n\\nWelcome to /r/Arableaks , People from all organizations, groups, and tendencies are welcome.\", \"subreddit_type\": \"public\", \"user_is_subscriber\": null}, \"post_hint\": \"self\", \"can_gild\": false, \"thumbnail_height\": null, \"hide_score\": true, \"spoiler\": false, \"permalink\": \"/r/arableaks/comments/6jzbmy/trumpcare_on_life_support_as_senate_punts_until/?ref=search_posts\", \"num_reports\": null, \"locked\": false, \"stickied\": false, \"created\": 1498668331.0, \"url\": \"https://www.reddit.com/r/arableaks/comments/6jzbmy/trumpcare_on_life_support_as_senate_punts_until/\", \"author_flair_text\": null, \"quarantine\": false, \"title\": \"Trumpcare on Life Support as Senate Punts Until After the Holiday Recess\", \"created_utc\": 1498639531.0, \"distinguished\": null, \"media\": null, \"num_comments\": 0, \"is_self\": true, \"visited\": false, \"subreddit_type\": \"public\", \"is_video\": false, \"ups\": 1}}, {\"kind\": \"t3\", \"data\": {\"contest_mode\": false, \"subreddit_name_prefixed\": \"r/AskEurope\", \"banned_by\": null, \"media_embed\": {}, \"thumbnail_width\": null, \"subreddit\": \"AskEurope\", \"selftext_html\": \"&lt;!-- SC_OFF --&gt;&lt;div class=\\\"md\\\"&gt;&lt;p&gt;I&amp;#39;m curious about different systems of healthcare from around the world, seeing the American model is not perfect (far from). I&amp;#39;d also like to explain what healthcare is like in mine if I get the opportunity. Here are my questions: &lt;/p&gt;\\n\\n&lt;blockquote&gt;\\n&lt;p&gt;What country are you from?&lt;/p&gt;\\n\\n&lt;p&gt;What do you like about your healthcare system?&lt;/p&gt;\\n\\n&lt;p&gt;How is it paid for?&lt;/p&gt;\\n\\n&lt;p&gt;Is it efficient? Cost effective, mortality rates, etc are my parameters for this question&lt;/p&gt;\\n\\n&lt;p&gt;Are you satisfied with your healthcare? &lt;/p&gt;\\n\\n&lt;p&gt;Are there private providers?&lt;/p&gt;\\n\\n&lt;p&gt;Any personal anecdotes?&lt;/p&gt;\\n\\n&lt;p&gt;What could be improved in the system?&lt;/p&gt;\\n&lt;/blockquote&gt;\\n\\n&lt;p&gt;In case you wanted to discuss American healthcare:&lt;/p&gt;\\n\\n&lt;blockquote&gt;\\n&lt;p&gt;What have you heard about American healthcare?&lt;/p&gt;\\n\\n&lt;p&gt;Do you have any questions about American healthcare for me?&lt;/p&gt;\\n&lt;/blockquote&gt;\\n&lt;/div&gt;&lt;!-- SC_ON --&gt;\", \"selftext\": \"I'm curious about different systems of healthcare from around the world, seeing the American model is not perfect (far from). I'd also like to explain what healthcare is like in mine if I get the opportunity. Here are my questions: \\n\\n&gt;What country are you from?\\n\\n&gt;What do you like about your healthcare system?\\n\\n&gt;How is it paid for?\\n\\n&gt;Is it efficient? Cost effective, mortality rates, etc are my parameters for this question\\n\\n&gt;Are you satisfied with your healthcare? \\n\\n&gt;Are there private providers?\\n\\n&gt;Any personal anecdotes?\\n\\n&gt;What could be improved in the system?\\n\\n\\nIn case you wanted to discuss American healthcare:\\n\\n&gt;What have you heard about American healthcare?\\n\\n&gt;Do you have any questions about American healthcare for me?\", \"likes\": null, \"suggested_sort\": null, \"user_reports\": [], \"secure_media\": null, \"link_flair_text\": \"Politics\", \"id\": \"6jzau9\", \"view_count\": null, \"secure_media_embed\": {}, \"clicked\": false, \"report_reasons\": null, \"author\": \"GlockInbound\", \"saved\": false, \"mod_reports\": [], \"name\": \"t3_6jzau9\", \"score\": 0, \"approved_by\": null, \"over_18\": false, \"domain\": \"self.AskEurope\", \"hidden\": false, \"thumbnail\": \"self\", \"subreddit_id\": \"t5_2uayg\", \"edited\": false, \"link_flair_css_class\": \"politics\", \"author_flair_css_class\": null, \"gilded\": 0, \"downs\": 0, \"brand_safe\": true, \"archived\": false, \"removal_reason\": null, \"sr_detail\": {\"banner_img\": \"\", \"user_is_banned\": null, \"description\": \"---\\n\\n**Got a question for a European, about Europe or anything Europe related? Then you came to the right place!**\\n\\n---\\n\\n**Posts from accounts younger than a month old are manually approved to avoid brigading and spam.**\\n\\n# Rules:\\n\\n[Please consult our wiki page for our posting rules.](https://www.reddit.com/r/AskEurope/wiki/rules)\\n\\n\\n# Posting Guidelines:\\n\\n 1. Be polite and courteous to everybody.\\n\\n 2. [Rediquette](http://www.reddit.com/wiki/reddiquette) should always be followed!\\n\\n 3. Have fun and learn about Europe!   \\n\\n 4. Posting in English is recommended for accessibility but is not mandatory. Please translate links and text where possible.\\n\\n \\n# General Info:\\n\\n- [EU on wikipedia](http://en.wikipedia.org/wiki/European_Union)\\n\\n- [European Foodbank Charities](http://www.eurofoodbank.eu/portail/index.php?option=com_content&amp;view=category&amp;layout=blog&amp;id=12&amp;Itemid=30&amp;lang=en)\\n\\n- [Phone plans / SIM cards advice](http://prepaid-data-sim-card.wikia.com/wiki/Category:Europe)\\n\\n- [New to reddit? click here!](/wiki/reddit_101)\\n\\n# Search AskEurope by flair\\n\\n||||\\n|--|--|--|\\n|[Serious](/r/AskEurope/search?q=flair%3ASerious&amp;restrict_sr=on  \\\"Serious\\\")|[Culture](/r/AskEurope/search?q=flair%3ACulture&amp;restrict_sr=on \\\"Culture\\\")|[Politics](/r/AskEurope/search?q=flair%3APolitics&amp;restrict_sr=on \\\"Politics\\\")|\\n|[Law](/r/AskEurope/search?q=flair%3ALaw&amp;restrict_sr=on \\\"Law\\\")|[History](/r/AskEurope/search?q=flair%3AHistory&amp;restrict_sr=on \\\"History\\\")|[Work](/r/AskEurope/search?q=flair%3AWork&amp;restrict_sr=on \\\"Work\\\")|\\n|[Travel](/r/AskEurope/search?q=flair%3ATravel&amp;restrict_sr=on \\\"Travel\\\")|[Foreign](/r/AskEurope/search?q=flair%3AForeign&amp;restrict_sr=on \\\"Foreign\\\")|[Misc](/r/AskEurope/search?q=flair%3AMisc&amp;restrict_sr=on \\\"Misc\\\")|\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n\\n# Europe-themed Subreddits:\\n\\n*  /r/Europe \\n\\n*  /r/europics \\n\\n*  /r/europeans \\n\\n* /r/europeanculture\\n\\n* /r/EuroDocs\\n\\n* /r/EuropeanFederalists\\n\\n* /r/Eurosceptics \\n\\n* /r/Interrail \\n\\n* /r/eulaw\\n\\n*  [List of European national and region subreddits](https://www.reddit.com/r/LocationReddits/wiki/faq/europe)\\n\\n# Ask a... subreddits\\n\\n* /r/AskAnAmerican\\n\\n* /r/AskACanadian\\n\\n* /r/AskanAustralian\\n\\n* /r/AskARussian\\n\\n* /r/FragReddit\\n\\n* /r/AskMENA\\n \", \"user_is_muted\": null, \"display_name\": \"AskEurope\", \"header_img\": \"https://d.thumbs.redditmedia.com/_-5zGESduEv9IG0Q.png\", \"title\": \"Ask Europe\", \"user_is_moderator\": null, \"over_18\": false, \"icon_size\": [256, 256], \"icon_img\": \"https://b.thumbs.redditmedia.com/QrWO8IQRgW0kuY7pTdmX2u7zs1ndumtk5qkjusMcTbg.png\", \"display_name_prefixed\": \"r/AskEurope\", \"header_size\": [124, 43], \"subscribers\": 15061, \"key_color\": \"#0079d3\", \"name\": \"t5_2uayg\", \"url\": \"/r/AskEurope/\", \"banner_size\": null, \"user_is_contributor\": null, \"public_description\": \"Ask Europe!\", \"subreddit_type\": \"public\", \"user_is_subscriber\": null}, \"can_gild\": false, \"thumbnail_height\": null, \"hide_score\": true, \"spoiler\": false, \"permalink\": \"/r/AskEurope/comments/6jzau9/hello_im_an_american_on_a_quest_to_find_out_how/?ref=search_posts\", \"num_reports\": null, \"locked\": false, \"stickied\": false, \"created\": 1498667946.0, \"url\": \"https://www.reddit.com/r/AskEurope/comments/6jzau9/hello_im_an_american_on_a_quest_to_find_out_how/\", \"author_flair_text\": null, \"quarantine\": false, \"title\": \"Hello. I'm an American on a quest to find out how healthcare works around the world. Let me ask the whole of Europe; what is healthcare like in your country?\", \"created_utc\": 1498639146.0, \"distinguished\": null, \"media\": null, \"num_comments\": 4, \"is_self\": true, \"visited\": false, \"subreddit_type\": \"public\", \"is_video\": false, \"ups\": 0}}], \"after\": \"t3_6jzau9\", \"before\": null}}"
    val fetcher = new TestFetcher(Map(
      Option("https://oauth.reddit.com/r/all/search.json") -> responseString,
      Option("https://www.reddit.com/api/v1/access_token")->"{\"access_token\":\"kaasZtJlZP-N0DKsGMr9cztURkM\",\"expires_in\":3600,\"scope\":\"*\",\"token_type\":\"bearer\"}"
    ))
    val client = new RedditClient("someAppId", "someAppSecret", fetcher = fetcher)
    client.ensureFreshToken()
    val objects = client.search(keywords = Seq("something"))
    assert(objects.nonEmpty)
  }

  it should "handle exceptions from malformed responses gracefully" in {
    val fetcher = new TestFetcher(Map(
      Option("https://oauth.reddit.com/r/all/search.json") -> "{badjson",
      Option("https://www.reddit.com/api/v1/access_token")->"{\"access_token\":\"kaasZtJlZP-N0DKsGMr9cztURkM\",\"expires_in\":3600,\"scope\":\"*\",\"token_type\":\"bearer\"}"
    ))
    val client = new RedditClient("someAppId", "someAppSecret", fetcher = fetcher)
    client.ensureFreshToken()
    val objects = client.search(keywords = Seq("something"))
    assert(objects.isEmpty)
  }

  it should "return an empty list when no search terms present" in {
    val fetcher = new TestFetcher(Map())
    val client = new RedditClient("someAppId", "someAppSecret", fetcher = fetcher)
    val objects = client.search(keywords = Seq())
    assert(objects.isEmpty)
  }

  it should "return an empty list when no token present" in {
    val fetcher = new TestFetcher(Map())
    val client = new RedditClient("someAppId", "someAppSecret", fetcher = fetcher)
    val objects = client.search(keywords = Seq("something"))
    assert(objects.isEmpty)
  }

}